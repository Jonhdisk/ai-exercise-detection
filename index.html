<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise Detection - MediaPipe BlazePose</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    
</head>
<body>
    <div class="container">
        <h1>üèãÔ∏è‚Äç‚ôÇÔ∏è AI Exercise Detection</h1>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î MediaPipe BlazePose...</span>
        </div>
        
        <div class="controls">
            <button id="pushupBtn" class="active" onclick="setExercise('pushup')">‡∏ß‡∏¥‡∏î‡∏û‡∏∑‡πâ‡∏ô (Push-up)</button>
            <button id="squatBtn" onclick="setExercise('squat')">‡∏™‡∏Ñ‡∏ß‡∏≠‡∏ó (Squat)</button>
            <button id="plankBtn" onclick="setExercise('plank')">‡πÅ‡∏û‡∏•‡∏á‡∏Ñ‡πå (Plank)</button>
            <button onclick="resetCounter()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        </div>
        
        <div class="video-container">
            <video id="inputVideo" width="640" height="480"></video>
            <canvas id="outputCanvas" width="640" height="480"></canvas>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</h3>
                <div class="stat-value" id="exerciseCount">0</div>
                <div id="exerciseType">Push-ups</div>
            </div>
            
            <div class="stat-card">
                <h3>‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á</h3>
                <div class="stat-value" id="formScore">--</div>
                <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / 100</div>
            </div>
            
            <div class="stat-card">
                <h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•</h3>
                <div class="balance-indicator">
                    <span>L</span>
                    <div class="balance-bar">
                        <div class="balance-fill" id="balanceFill" style="width: 50%;"></div>
                    </div>
                    <span>R</span>
                </div>
                <div id="balanceText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>
            </div>
            
            <div class="stat-card">
                <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                <div class="stat-value" id="currentState">--</div>
                <div id="currentAngle">‡∏°‡∏∏‡∏°: --¬∞</div>
            </div>
        </div>
        
        <div id="warningArea"></div>
    </div>

    <script>
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö MediaPipe
        let pose;
        let camera;
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
        let exerciseCount = 0;
        let currentExercise = 'pushup';
        let exerciseState = 'up';
        let lastAngle = 0;
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°
        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) {
                angle = 360 - angle;
            }
            return angle;
        }
        
        // ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö Push-up
        function detectPushup(landmarks) {
            try {
                const leftShoulder = landmarks[11];
                const leftElbow = landmarks[13];
                const leftWrist = landmarks[15];
                const rightShoulder = landmarks[12];
                const rightElbow = landmarks[14];
                const rightWrist = landmarks[16];
                
                const leftAngle = calculateAngle(leftShoulder, leftElbow, leftWrist);
                const rightAngle = calculateAngle(rightShoulder, rightElbow, rightWrist);
                const avgAngle = (leftAngle + rightAngle) / 2;
                
                // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏î‡∏∏‡∏•
                const balanceDiff = Math.abs(leftAngle - rightAngle);
                const balanceScore = Math.max(0, 100 - balanceDiff * 2);
                
                // ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
                if (avgAngle > 160 && exerciseState === 'down') {
                    exerciseState = 'up';
                    exerciseCount++;
                }
                else if (avgAngle < 90 && exerciseState === 'up') {
                    exerciseState = 'down';
                }
                
                return {
                    angle: avgAngle,
                    balance: balanceScore,
                    balanceDiff: balanceDiff,
                    leftAngle: leftAngle,
                    rightAngle: rightAngle,
                    state: exerciseState
                };
            } catch (e) {
                return null;
            }
        }
        
        // ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö Squat
        function detectSquat(landmarks) {
            try {
                const leftHip = landmarks[23];
                const leftKnee = landmarks[25];
                const leftAnkle = landmarks[27];
                const rightHip = landmarks[24];
                const rightKnee = landmarks[26];
                const rightAnkle = landmarks[28];
                
                const leftAngle = calculateAngle(leftHip, leftKnee, leftAnkle);
                const rightAngle = calculateAngle(rightHip, rightKnee, rightAnkle);
                const avgAngle = (leftAngle + rightAngle) / 2;
                
                const balanceDiff = Math.abs(leftAngle - rightAngle);
                const balanceScore = Math.max(0, 100 - balanceDiff * 3);
                
                if (avgAngle > 160 && exerciseState === 'down') {
                    exerciseState = 'up';
                    exerciseCount++;
                }
                else if (avgAngle < 100 && exerciseState === 'up') {
                    exerciseState = 'down';
                }
                
                return {
                    angle: avgAngle,
                    balance: balanceScore,
                    balanceDiff: balanceDiff,
                    leftAngle: leftAngle,
                    rightAngle: rightAngle,
                    state: exerciseState
                };
            } catch (e) {
                return null;
            }
        }
        
        // ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö Plank
        function detectPlank(landmarks) {
            try {
                const leftShoulder = landmarks[11];
                const leftHip = landmarks[23];
                const leftKnee = landmarks[25];
                const rightShoulder = landmarks[12];
                const rightHip = landmarks[24];
                const rightKnee = landmarks[26];
                
                // ‡∏°‡∏∏‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (shoulder-hip-knee)
                const leftBackAngle = calculateAngle(leftShoulder, leftHip, leftKnee);
                const rightBackAngle = calculateAngle(rightShoulder, rightHip, rightKnee);
                const avgBackAngle = (leftBackAngle + rightBackAngle) / 2;
                
                const balanceDiff = Math.abs(leftBackAngle - rightBackAngle);
                const balanceScore = Math.max(0, 100 - balanceDiff * 2);
                
                // Plank ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏á (‡∏°‡∏∏‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 170-180 ‡∏≠‡∏á‡∏®‡∏≤)
                const formScore = Math.max(0, 100 - Math.abs(180 - avgBackAngle) * 2);
                
                return {
                    angle: avgBackAngle,
                    balance: balanceScore,
                    balanceDiff: balanceDiff,
                    formScore: formScore,
                    state: formScore > 70 ? 'good' : 'poor'
                };
            } catch (e) {
                return null;
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function updateUI(exerciseData) {
            if (!exerciseData) return;
            
            document.getElementById('exerciseCount').textContent = exerciseCount;
            document.getElementById('formScore').textContent = Math.round(exerciseData.balance || exerciseData.formScore || 0);
            document.getElementById('currentState').textContent = exerciseData.state;
            document.getElementById('currentAngle').textContent = `‡∏°‡∏∏‡∏°: ${Math.round(exerciseData.angle)}¬∞`;
            
            // Balance indicator
            const balancePercentage = exerciseData.balance || 50;
            document.getElementById('balanceFill').style.width = balancePercentage + '%';
            
            if (exerciseData.balanceDiff !== undefined) {
                if (exerciseData.balanceDiff < 10) {
                    document.getElementById('balanceText').textContent = '‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏î‡∏µ';
                } else if (exerciseData.balanceDiff < 20) {
                    document.getElementById('balanceText').textContent = '‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢';
                } else {
                    document.getElementById('balanceText').textContent = '‡πÑ‡∏°‡πà‡∏™‡∏°‡∏î‡∏∏‡∏•!';
                }
            }
            
            // Warning
            const warningArea = document.getElementById('warningArea');
            if (exerciseData.balanceDiff > 20) {
                warningArea.innerHTML = '<div class="warning">‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏°‡∏î‡∏∏‡∏•! ‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á</div>';
            } else {
                warningArea.innerHTML = '';
            }
        }
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å MediaPipe
        function onResults(results) {
            const canvasElement = document.getElementById('outputCanvas');
            const canvasCtx = canvasElement.getContext('2d');
            
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.poseLandmarks) {
                // ‡∏ß‡∏≤‡∏î pose landmarks
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 1});
                
                // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢
                let exerciseData = null;
                
                switch(currentExercise) {
                    case 'pushup':
                        exerciseData = detectPushup(results.poseLandmarks);
                        break;
                    case 'squat':
                        exerciseData = detectSquat(results.poseLandmarks);
                        break;
                    case 'plank':
                        exerciseData = detectPlank(results.poseLandmarks);
                        break;
                }
                
                updateUI(exerciseData);
            }
            
            canvasCtx.restore();
        }
        
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢
        function setExercise(exercise) {
            currentExercise = exercise;
            exerciseState = 'up';
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
            document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(exercise + 'Btn').classList.add('active');
            
            const exerciseNames = {
                'pushup': 'Push-ups',
                'squat': 'Squats', 
                'plank': 'Plank Hold'
            };
            
            document.getElementById('exerciseType').textContent = exerciseNames[exercise];
        }
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö
        function resetCounter() {
            exerciseCount = 0;
            exerciseState = 'up';
            document.getElementById('exerciseCount').textContent = '0';
            document.getElementById('warningArea').innerHTML = '';
        }
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        async function initializeSystem() {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î MediaPipe Pose
                pose = new Pose({
                    locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                    }
                });
                
                pose.setOptions({
                    modelComplexity: 2,
                    smoothLandmarks: true,
                    enableSegmentation: false,
                    smoothSegmentation: false,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.5
                });
                
                pose.onResults(onResults);
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á
                const videoElement = document.getElementById('inputVideo');
                camera = new Camera(videoElement, {
                    onFrame: async () => {
                        await pose.send({image: videoElement});
                    },
                    width: 640,
                    height: 480
                });
                
                await camera.start();
                
                // ‡∏ã‡πà‡∏≠‡∏ô loading
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error initializing system:', error);
                document.getElementById('loading').innerHTML = '<div style="color: red;">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>';
            }
        }
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        window.addEventListener('load', initializeSystem);
    </script>
</body>
</html>
