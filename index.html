<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตรวจจับการชนข้อมือ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.0.0/dist/pose-detection.min.js"></script>
</head>
<body>
    <h1>ตรวจจับการชนข้อมือ</h1>
    
    <div id="loading">กำลังโหลด MoveNet Model...</div>
    
    <div>
        <video id="inputVideo" width="640" height="480" autoplay playsinline style="transform: scaleX(-1);"></video>
        <canvas id="outputCanvas" width="640" height="480"></canvas>
    </div>
    
    <div>
        <p>จำนวนครั้งที่ชน: <span id="clapCount">0</span> / 3 ครั้ง</p>
        <p>ระยะห่างข้อมือ: <span id="wristDistance">--</span> พิกเซล</p>
        <p>สถานะ: <span id="statusText">กำลังเริ่มระบบ...</span></p>
    </div>
    
    <div id="instructionArea">
        <h3>คำแนะนำ:</h3>
        <p>ชนข้อมือกัน 3 ครั้ง ระบบจะเริ่มนับถอยหลังอัตโนมัติ</p>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdownOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1000;">
        <div id="countdownNumber" style="font-size: 5rem; color: #FFD700; font-weight: bold;">5</div>
        <div style="font-size: 2rem; color: white; margin-top: 20px;">เตรียมตัวให้พร้อม!</div>
    </div>

    <script>
        // MoveNet keypoints mapping
        const KEYPOINT_DICT = {
            'nose': 0,
            'left_eye': 1,
            'right_eye': 2,
            'left_ear': 3,
            'right_ear': 4,
            'left_shoulder': 5,
            'right_shoulder': 6,
            'left_elbow': 7,
            'right_elbow': 8,
            'left_wrist': 9,
            'right_wrist': 10,
            'left_hip': 11,
            'right_hip': 12,
            'left_knee': 13,
            'right_knee': 14,
            'left_ankle': 15,
            'right_ankle': 16
        };

        // Variables
        let detector;
        let video;
        let canvas;
        let ctx;
        let stream;
        let animationId;
        
        // Wrist clap detection variables
        let wristClapCount = 0;
        let wristClapState = 'apart'; // 'apart' or 'together'
        let lastClapTime = 0;
        let clapDetectionThreshold = 100; // pixels
        let clapCooldown = 800; // milliseconds
        
        // Initialize system
        async function initializeSystem() {
            try {
                console.log('Loading MoveNet model...');
                
                // Load MoveNet model
                const model = poseDetection.SupportedModels.MoveNet;
                const detectorConfig = {
                    modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
                };
                
                detector = await poseDetection.createDetector(model, detectorConfig);
                console.log('MoveNet model loaded successfully');
                
                // Setup video
                video = document.getElementById('inputVideo');
                canvas = document.getElementById('outputCanvas');
                ctx = canvas.getContext('2d');
                
                // Get camera stream
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: 640,
                        height: 480,
                        facingMode: 'user'
                    }
                });
                
                video.srcObject = stream;
                video.addEventListener('loadeddata', () => {
                    console.log('Video loaded, starting detection...');
                    detectPose();
                    updateStatusText('กำลังตรวจจับการชนข้อมือ...');
                });
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error initializing system:', error);
                document.getElementById('loading').innerHTML = 'ไม่สามารถเริ่มระบบได้ กรุณาตรวจสอบการเชื่อมต่อกล้อง';
            }
        }
        
        // Calculate distance between two points
        function calculateDistance(point1, point2) {
            const dx = point1.x - point2.x;
            const dy = point1.y - point2.y;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // Mirror keypoint coordinates to match flipped video
        function mirrorKeypoint(keypoint, canvasWidth) {
            return {
                ...keypoint,
                x: canvasWidth - keypoint.x
            };
        }
        
        // Update status text
        function updateStatusText(text) {
            document.getElementById('statusText').textContent = text;
        }
        
        // Detect wrist clap
        function detectWristClap(keypoints) {
            const leftWrist = keypoints[KEYPOINT_DICT.left_wrist];
            const rightWrist = keypoints[KEYPOINT_DICT.right_wrist];
            
            // Check if both wrists are detected with good confidence
            if (!leftWrist || !rightWrist || leftWrist.score < 0.4 || rightWrist.score < 0.4) {
                return false;
            }
            
            // Mirror the wrist coordinates to match the flipped video display
            const mirroredLeftWrist = mirrorKeypoint(leftWrist, canvas.width);
            const mirroredRightWrist = mirrorKeypoint(rightWrist, canvas.width);
            
            const currentTime = Date.now();
            const wristDistance = calculateDistance(mirroredLeftWrist, mirroredRightWrist);
            
            // Update distance display
            document.getElementById('wristDistance').textContent = Math.round(wristDistance);
            
            // Detect clap (wrists coming together)
            if (wristDistance < clapDetectionThreshold && wristClapState === 'apart' && 
                currentTime - lastClapTime > clapCooldown) {
                
                wristClapState = 'together';
                wristClapCount++;
                lastClapTime = currentTime;
                
                // Update UI
                document.getElementById('clapCount').textContent = wristClapCount;
                updateStatusText(`ชนครั้งที่ ${wristClapCount}! ${wristClapCount < 3 ? `อีก ${3 - wristClapCount} ครั้ง` : 'เสร็จสิ้น!'}`);
                
                // Check if we've reached 3 claps
                if (wristClapCount >= 3) {
                    completeWristClapDetection();
                    return true;
                }
                
            } else if (wristDistance > clapDetectionThreshold * 1.5 && wristClapState === 'together') {
                wristClapState = 'apart';
            }
            
            // Draw wrist clap visualization using mirrored coordinates
            drawWristClapVisualization(mirroredLeftWrist, mirroredRightWrist, wristDistance);
            
            return false;
        }
        
        // Draw wrist clap visualization
        function drawWristClapVisualization(leftWrist, rightWrist, distance) {
            // Draw line between wrists (on top of skeleton)
            ctx.strokeStyle = distance < clapDetectionThreshold ? '#FF0000' : '#FFFF00';
            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.moveTo(leftWrist.x, leftWrist.y);
            ctx.lineTo(rightWrist.x, rightWrist.y);
            ctx.stroke();
            
            // Draw wrist circles (larger and more visible)
            ctx.fillStyle = distance < clapDetectionThreshold ? '#FF0000' : '#FFFF00';
            ctx.beginPath();
            ctx.arc(leftWrist.x, leftWrist.y, 15, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(rightWrist.x, rightWrist.y, 15, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw distance text
            const midX = (leftWrist.x + rightWrist.x) / 2;
            const midY = (leftWrist.y + rightWrist.y) / 2;
            
            ctx.fillStyle = '#FFFFFF';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.strokeText(`${Math.round(distance)}px`, midX, midY - 30);
            ctx.fillText(`${Math.round(distance)}px`, midX, midY - 30);
        }
        
        // Complete wrist clap detection
        function completeWristClapDetection() {
            updateStatusText('ตรวจจับเสร็จสิ้น! กำลังเริ่มนับถอยหลัง...');
            
            // Start countdown after successful wrist claps
            setTimeout(() => {
                startCountdown();
            }, 1000);
        }
        
        // Start countdown
        function startCountdown() {
            const overlay = document.getElementById('countdownOverlay');
            const numberElement = document.getElementById('countdownNumber');
            
            overlay.style.display = 'flex';
            let count = 5;
            
            const countdownInterval = setInterval(() => {
                numberElement.textContent = count;
                
                count--;
                
                if (count < 0) {
                    clearInterval(countdownInterval);
                    
                    // Show "GO!" or "เริ่ม!"
                    numberElement.textContent = 'เริ่ม!';
                    numberElement.style.color = '#00FF00';
                    
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        numberElement.style.color = '#FFD700';
                        
                        // Reset system for next round
                        resetSystem();
                        
                        alert('เริ่มทำงาน! สามารถเริ่มกิจกรรมได้แล้ว');
                    }, 1500);
                }
            }, 1000);
        }
        
        // Reset system
        function resetSystem() {
            wristClapCount = 0;
            wristClapState = 'apart';
            lastClapTime = 0;
            
            document.getElementById('clapCount').textContent = '0';
            document.getElementById('wristDistance').textContent = '--';
            updateStatusText('รีเซ็ตเสร็จสิ้น - กำลังตรวจจับการชนข้อมือ...');
        }
        
        // Draw basic skeleton with mirrored coordinates
        function drawBasicSkeleton(keypoints) {
            // Mirror all keypoints for display
            const mirroredKeypoints = keypoints.map(kp => mirrorKeypoint(kp, canvas.width));
            
            // Draw keypoints
            ctx.fillStyle = '#00FF00';
            mirroredKeypoints.forEach((keypoint, index) => {
                if (keypoint.score > 0.3) {
                    ctx.beginPath();
                    ctx.arc(keypoint.x, keypoint.y, 6, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Label keypoints for debugging
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '12px Arial';
                    ctx.fillText(index, keypoint.x + 8, keypoint.y - 8);
                    ctx.fillStyle = '#00FF00';
                }
            });
            
            // Draw connections
            const connections = [
                [5, 6], // shoulders
                [5, 7], [7, 9], // left arm
                [6, 8], [8, 10], // right arm
                [5, 11], [6, 12], // torso
                [11, 12], // hips
                [11, 13], [13, 15], // left leg
                [12, 14], [14, 16], // right leg
                [0, 1], [0, 2], // face
                [1, 3], [2, 4] // ears
            ];
            
            ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = 2;
            
            connections.forEach(([i, j]) => {
                const kp1 = mirroredKeypoints[i];
                const kp2 = mirroredKeypoints[j];
                
                if (kp1 && kp2 && kp1.score > 0.3 && kp2.score > 0.3) {
                    ctx.beginPath();
                    ctx.moveTo(kp1.x, kp1.y);
                    ctx.lineTo(kp2.x, kp2.y);
                    ctx.stroke();
                }
            });
        }

        // Draw pose on canvas
        function drawPose(poses) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw mirrored video background
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();
            
            if (poses.length > 0) {
                const pose = poses[0];
                const keypoints = pose.keypoints;
                
                // Draw basic skeleton first (with mirrored coordinates)
                drawBasicSkeleton(keypoints);
                
                // Then check for wrist clap and draw wrist visualization
                detectWristClap(keypoints);
                
                return keypoints;
            }
            return null;
        }
        
        // Main detection loop
        async function detectPose() {
            if (video.readyState >= 2) {
                try {
                    const poses = await detector.estimatePoses(video);
                    drawPose(poses);
                } catch (error) {
                    console.error('Detection error:', error);
                }
            }
            
            animationId = requestAnimationFrame(detectPose);
        }
        
        // Initialize when page loads
        window.addEventListener('load', initializeSystem);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>
