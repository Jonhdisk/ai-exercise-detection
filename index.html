<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตรวจจับการโบกมือ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.0.0/dist/pose-detection.min.js"></script>
    <style>
        body { margin: 0; padding: 10px; text-align: center; }
        .video-container { position: relative; display: inline-block; }
        #inputVideo { position: absolute; top: 0; left: 0; }
        #outputCanvas { position: relative; z-index: 1; }
        #countdownOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 1000; }
        #countdownNumber { font-size: 4rem; color: #FFD700; font-weight: bold; }
        .wave-count { color: #2196F3; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ตรวจจับการโบกมือ</h1>
        
        <div id="loading">กำลังโหลด MoveNet Model...</div>
        
        <div class="video-container" id="videoContainer" style="display: none;">
            <video id="inputVideo" autoplay playsinline muted></video>
            <canvas id="outputCanvas"></canvas>
        </div>
        
        <div class="info-panel">
            <div class="status-text" id="statusText">กำลังเริ่มระบบ...</div>
            <div>จำนวนครั้งที่โบก: <span class="wave-count" id="waveCount">0</span> / 3 ครั้ง</div>
            <div>ระยะการเคลื่อนไหวมือ: <span id="handMovement">--</span></div>
        </div>
        
        <div class="instruction">
            <h3>คำแนะนำ:</h3>
            <p>ยกมือขวาขึ้นแล้วโบกซ้าย-ขวา 3 ครั้ง<br>ระบบจะเริ่มนับถอยหลังอัตโนมัติ</p>
        </div>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdownOverlay">
        <div id="countdownNumber">5</div>
        <div class="subtitle">เตรียมตัวให้พร้อม!</div>
    </div>

    <script>
        // MoveNet keypoints mapping
        const KEYPOINT_DICT = {
            'nose': 0,
            'left_eye': 1,
            'right_eye': 2,
            'left_ear': 3,
            'right_ear': 4,
            'left_shoulder': 5,
            'right_shoulder': 6,
            'left_elbow': 7,
            'right_elbow': 8,
            'left_wrist': 9,
            'right_wrist': 10,
            'left_hip': 11,
            'right_hip': 12,
            'left_knee': 13,
            'right_knee': 14,
            'left_ankle': 15,
            'right_ankle': 16
        };

        // Variables
        let detector;
        let video;
        let canvas;
        let ctx;
        let stream;
        let animationId;
        let videoWidth = 640;
        let videoHeight = 480;
        
        // Hand wave detection variables
        let waveCount = 0;
        let waveState = 'center'; // 'left', 'center', 'right'
        let lastWaveTime = 0;
        let waveCooldown = 500; // milliseconds
        let rightWristHistory = [];
        let historyLength = 10;
        let waveThreshold = 50; // pixels movement threshold
        
        // Resize canvas to match video dimensions
        function resizeCanvas() {
            if (video && video.videoWidth && video.videoHeight) {
                videoWidth = video.videoWidth;
                videoHeight = video.videoHeight;
                
                // Calculate responsive dimensions
                const containerWidth = Math.min(400, window.innerWidth * 0.9);
                const aspectRatio = videoHeight / videoWidth;
                const containerHeight = containerWidth * aspectRatio;
                
                // Set canvas dimensions
                canvas.width = videoWidth;
                canvas.height = videoHeight;
                
                // Set display dimensions
                canvas.style.width = containerWidth + 'px';
                canvas.style.height = containerHeight + 'px';
                video.style.width = containerWidth + 'px';
                video.style.height = containerHeight + 'px';
            }
        }
        
        // Initialize system
        async function initializeSystem() {
            try {
                console.log('Loading MoveNet model...');
                
                // Load MoveNet model
                const model = poseDetection.SupportedModels.MoveNet;
                const detectorConfig = {
                    modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
                };
                
                detector = await poseDetection.createDetector(model, detectorConfig);
                console.log('MoveNet model loaded successfully');
                
                // Setup video
                video = document.getElementById('inputVideo');
                canvas = document.getElementById('outputCanvas');
                ctx = canvas.getContext('2d');
                
                // Get camera stream with flexible constraints
                const constraints = {
                    video: {
                        facingMode: 'user',
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.addEventListener('loadedmetadata', () => {
                    console.log('Video metadata loaded');
                    resizeCanvas();
                });
                
                video.addEventListener('loadeddata', () => {
                    console.log('Video loaded, starting detection...');
                    document.getElementById('videoContainer').style.display = 'block';
                    detectPose();
                    updateStatusText('กำลังตรวจจับการโบกมือ...');
                });
                
                // Handle window resize
                window.addEventListener('resize', resizeCanvas);
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('Error initializing system:', error);
                document.getElementById('loading').innerHTML = 'ไม่สามารถเริ่มระบบได้ กรุณาตรวจสอบการเชื่อมต่อกล้อง';
            }
        }
        
        // Update status text
        function updateStatusText(text) {
            document.getElementById('statusText').textContent = text;
        }
        
        // Scale coordinates to canvas dimensions
        function scaleCoordinates(keypoints) {
            return keypoints.map(keypoint => ({
                ...keypoint,
                x: keypoint.x * videoWidth,
                y: keypoint.y * videoHeight
            }));
        }
        
        // Detect hand wave
        function detectHandWave(keypoints) {
            const scaledKeypoints = scaleCoordinates(keypoints);
            const rightWrist = scaledKeypoints[KEYPOINT_DICT.right_wrist];
            const rightShoulder = scaledKeypoints[KEYPOINT_DICT.right_shoulder];
            
            // Check if right wrist and shoulder are detected with good confidence
            if (!rightWrist || !rightShoulder || rightWrist.score < 0.4 || rightShoulder.score < 0.4) {
                return false;
            }
            
            // Check if hand is raised (wrist above shoulder)
            if (rightWrist.y > rightShoulder.y) {
                updateStatusText('ยกมือขวาขึ้นเพื่อเริ่มโบก');
                return false;
            }
            
            const currentTime = Date.now();
            
            // Add current wrist position to history
            rightWristHistory.push({
                x: rightWrist.x,
                y: rightWrist.y,
                time: currentTime
            });
            
            // Keep only recent history
            if (rightWristHistory.length > historyLength) {
                rightWristHistory.shift();
            }
            
            // Need enough history to detect wave
            if (rightWristHistory.length < historyLength) {
                return false;
            }
            
            // Calculate horizontal movement
            const oldPos = rightWristHistory[0];
            const newPos = rightWristHistory[rightWristHistory.length - 1];
            const horizontalMovement = Math.abs(newPos.x - oldPos.x);
            
            // Scale threshold based on video width
            const scaledThreshold = waveThreshold * (videoWidth / 640);
            
            // Update movement display
            document.getElementById('handMovement').textContent = `${Math.round(horizontalMovement)}px`;
            
            // Detect wave pattern (significant horizontal movement)
            if (horizontalMovement > scaledThreshold && currentTime - lastWaveTime > waveCooldown) {
                
                // Determine wave direction
                const direction = newPos.x > oldPos.x ? 'right' : 'left';
                
                // Check for complete wave cycle
                if ((waveState === 'center' && direction === 'right') ||
                    (waveState === 'right' && direction === 'left') ||
                    (waveState === 'left' && direction === 'right')) {
                    
                    if (waveState === 'left' && direction === 'right') {
                        // Complete wave cycle
                        waveCount++;
                        lastWaveTime = currentTime;
                        
                        // Update UI
                        document.getElementById('waveCount').textContent = waveCount;
                        updateStatusText(`โบกครั้งที่ ${waveCount}! ${waveCount < 3 ? `อีก ${3 - waveCount} ครั้ง` : 'เสร็จสิ้น!'}`);
                        
                        // Check if we've reached 3 waves
                        if (waveCount >= 3) {
                            completeHandWaveDetection();
                            return true;
                        }
                    }
                    
                    waveState = direction;
                }
                
                // Clear history after detection
                rightWristHistory = [];
            }
            
            // Draw wave visualization
            drawWaveVisualization(rightWrist, rightShoulder, horizontalMovement, scaledThreshold);
            
            return false;
        }
        
        // Draw wave visualization
        function drawWaveVisualization(rightWrist, rightShoulder, movement, threshold) {
            // Draw hand raised indicator
            ctx.strokeStyle = rightWrist.y < rightShoulder.y ? '#00FF00' : '#FF0000';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(rightShoulder.x, rightShoulder.y);
            ctx.lineTo(rightWrist.x, rightWrist.y);
            ctx.stroke();
            
            // Draw wrist circle
            ctx.fillStyle = movement > threshold ? '#FFD700' : '#00FF00';
            ctx.beginPath();
            ctx.arc(rightWrist.x, rightWrist.y, 12, 0, 2 * Math.PI);
            ctx.fill();
            
            // Draw movement indicator
            if (movement > threshold) {
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 6;
                ctx.beginPath();
                ctx.arc(rightWrist.x, rightWrist.y, 25, 0, 2 * Math.PI);
                ctx.stroke();
            }
            
            // Draw status text on canvas
            ctx.fillStyle = '#FFFFFF';
            ctx.font = `bold ${Math.max(14, videoWidth / 40)}px Arial`;
            ctx.textAlign = 'center';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            
            const statusText = rightWrist.y < rightShoulder.y ? 'โบกซ้าย-ขวา' : 'ยกมือขึ้น';
            ctx.strokeText(statusText, rightWrist.x, rightWrist.y - 40);
            ctx.fillText(statusText, rightWrist.x, rightWrist.y - 40);
        }
        
        // Complete hand wave detection
        function completeHandWaveDetection() {
            updateStatusText('ตรวจจับเสร็จสิ้น! กำลังเริ่มนับถอยหลัง...');
            
            // Start countdown after successful waves
            setTimeout(() => {
                startCountdown();
            }, 1000);
        }
        
        // Start countdown
        function startCountdown() {
            const overlay = document.getElementById('countdownOverlay');
            const numberElement = document.getElementById('countdownNumber');
            
            overlay.style.display = 'flex';
            let count = 5;
            
            const countdownInterval = setInterval(() => {
                numberElement.textContent = count;
                
                count--;
                
                if (count < 0) {
                    clearInterval(countdownInterval);
                    
                    // Show "GO!" or "เริ่ม!"
                    numberElement.textContent = 'เริ่ม!';
                    numberElement.style.color = '#00FF00';
                    
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        numberElement.style.color = '#FFD700';
                        
                        // Reset system for next round
                        resetSystem();
                        
                        alert('เริ่มทำงาน! สามารถเริ่มกิจกรรมได้แล้ว');
                    }, 1500);
                }
            }, 1000);
        }
        
        // Reset system
        function resetSystem() {
            waveCount = 0;
            waveState = 'center';
            lastWaveTime = 0;
            rightWristHistory = [];
            
            document.getElementById('waveCount').textContent = '0';
            document.getElementById('handMovement').textContent = '--';
            updateStatusText('รีเซ็ตเสร็จสิ้น - กำลังตรวจจับการโบกมือ...');
        }
        
        // Draw basic skeleton
        function drawBasicSkeleton(keypoints) {
            const scaledKeypoints = scaleCoordinates(keypoints);
            
            // Draw keypoints
            ctx.fillStyle = '#00FF00';
            scaledKeypoints.forEach((keypoint, index) => {
                if (keypoint.score > 0.3) {
                    ctx.beginPath();
                    ctx.arc(keypoint.x, keypoint.y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
            
            // Draw connections
            const connections = [
                [5, 6], // shoulders
                [5, 7], [7, 9], // left arm
                [6, 8], [8, 10], // right arm
                [5, 11], [6, 12], // torso
                [11, 12], // hips
                [11, 13], [13, 15], // left leg
                [12, 14], [14, 16], // right leg
            ];
            
            ctx.strokeStyle = '#00FF00';
            ctx.lineWidth = 2;
            
            connections.forEach(([i, j]) => {
                const kp1 = scaledKeypoints[i];
                const kp2 = scaledKeypoints[j];
                
                if (kp1 && kp2 && kp1.score > 0.3 && kp2.score > 0.3) {
                    ctx.beginPath();
                    ctx.moveTo(kp1.x, kp1.y);
                    ctx.lineTo(kp2.x, kp2.y);
                    ctx.stroke();
                }
            });
        }

        // Draw pose on canvas
        function drawPose(poses) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            if (poses.length > 0) {
                const pose = poses[0];
                const keypoints = pose.keypoints;
                
                // Draw basic skeleton first
                drawBasicSkeleton(keypoints);
                
                // Then check for hand wave and draw visualization
                detectHandWave(keypoints);
                
                return keypoints;
            }
            return null;
        }
        
        // Main detection loop
        async function detectPose() {
            if (video.readyState >= 2) {
                try {
                    const poses = await detector.estimatePoses(video);
                    drawPose(poses);
                } catch (error) {
                    console.error('Detection error:', error);
                }
            }
            
            animationId = requestAnimationFrame(detectPose);
        }
        
        // Initialize when page loads
        window.addEventListener('load', initializeSystem);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>
